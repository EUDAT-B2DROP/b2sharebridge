(()=>{"use strict";var t,e={556(t,e,n){n.d(e,{A:()=>a});var s=n(1354),o=n.n(s),r=n(6314),i=n.n(r)()(o());i.push([t.id,"\n#bridgedial {\n\tmin-width: 60%;\n}\n#bridgedial .select {\n\twidth: 100%;\n}\n#bridgedial .modal__content,\n#infodial .modal__content {\n\tmargin: 50px;\n}\n#bridgedial .modal__content h2,\n#infodial .modal__content h2 {\n\ttext-align: center;\n}\n#bridgedial .form-group,\n#infodial .form-group {\n\tmargin: calc(var(--default-grid-baseline) * 4) 0;\n\tdisplay: flex;\n\tflex-direction: column;\n\talign-items: flex-start;\n}\n#bridgedial .button-container,\n#infodial .button-container {\n\tdisplay: flex;\n\tflex-direction: row;\n\talign-items: start;\n\tjustify-content: flex-end;\n}\n#bridgedial .selecterror div {\n\tborder-color: red;\n}\n#infodial a {\n\tborder-radius: var(--border-radius-pill);\n}\n","",{version:3,sources:["webpack://./src/components/BridgeDialog.vue"],names:[],mappings:";AAknBA;CACC,cAAc;AACf;AAEA;CACC,WAAW;AACZ;AAEA;;CAEC,YAAY;AACb;AAEA;;CAEC,kBAAkB;AACnB;AAEA;;CAEC,gDAAgD;CAChD,aAAa;CACb,sBAAsB;CACtB,uBAAuB;AACxB;AAEA;;CAEC,aAAa;CACb,mBAAmB;CACnB,kBAAkB;CAClB,yBAAyB;AAC1B;AAEA;CACC,iBAAiB;AAClB;AAEA;CACC,wCAAwC;AACzC",sourcesContent:["<template>\n\t<NcModal v-if=\"info.message !== ''\" id=\"infodial\" name=\"\">\n\t\t<div class=\"modal__content\">\n\t\t\t<h2>{{ info.heading }}</h2>\n\t\t\t<p>{{ info.message }}</p>\n\t\t\t<span class=\"button-container\">\n\t\t\t\t<NcButton\n\t\t\t\t\tv-for=\"button in info.buttons\"\n\t\t\t\t\t:key=\"button.label\"\n\t\t\t\t\t:href=\"button.href\"\n\t\t\t\t\t:type=\"button.type\"\n\t\t\t\t\t:area-label=\"button.label\"\n\t\t\t\t\t@click=\"button.callback\">\n\t\t\t\t\t{{ button.label }}\n\t\t\t\t</NcButton>\n\t\t\t</span>\n\t\t</div>\n\t</NcModal>\n\t<NcModal v-else-if=\"showDialog\" id=\"bridgedial\" name=\"\">\n\t\t<div class=\"modal__content\">\n\t\t\t<h2>Upload data to B2SHARE</h2>\n\t\t\t<NcSelect\n\t\t\t\tv-bind=\"modeprops\"\n\t\t\t\tv-model=\"modeprops.value\"\n\t\t\t\trequired\n\t\t\t\t:class=\"{ selecterror: modeprops.error }\"\n\t\t\t\t@update:model-value=\"onChangeMode()\" />\n\t\t\t<NcTextField\n\t\t\t\tv-if=\"!modeprops.value || modeprops.value.id === 'create'\"\n\t\t\t\tv-model=\"title.text\"\n\t\t\t\tlabel=\"Title\"\n\t\t\t\tplaceholder=\"Please enter a title\"\n\t\t\t\t:disabled=\"!modeprops.value\"\n\t\t\t\t:error=\"title.error\"\n\t\t\t\t:success=\"title.success\"\n\t\t\t\tminlength=\"3\"\n\t\t\t\tmaxlength=\"128\"\n\t\t\t\t:helper-text=\"title.helpertext\"\n\t\t\t\t@update:model-value=\"validate\">\n\t\t\t\t<PencilIcon :size=\"20\" />\n\t\t\t</NcTextField>\n\t\t\t<NcSelect\n\t\t\t\tv-bind=\"serverprops\"\n\t\t\t\tv-model=\"serverprops.value\"\n\t\t\t\trequired\n\t\t\t\t:class=\"{ selecterror: serverprops.error }\"\n\t\t\t\t@update:model-value=\"onChangeServer\" />\n\t\t\t<NcSelect\n\t\t\t\tv-if=\"modeprops.value && modeprops.value.id === 'attach'\"\n\t\t\t\tv-bind=\"depositselectprops\"\n\t\t\t\tv-model=\"depositselectprops.value\"\n\t\t\t\trequired\n\t\t\t\t:class=\"{ selecterror: depositselectprops.error }\"\n\t\t\t\t@update:model-value=\"validate\" />\n\t\t\t<NcSelect\n\t\t\t\tv-if=\"!modeprops.value || modeprops.value.id === 'create'\"\n\t\t\t\tv-bind=\"communityprops\"\n\t\t\t\tv-model=\"communityprops.value\"\n\t\t\t\t:disabled=\"!modeprops.value\"\n\t\t\t\trequired\n\t\t\t\t:class=\"{ selecterror: communityprops.error }\"\n\t\t\t\t@update:model-value=\"validate\" />\n\t\t\t<NcCheckboxRadioSwitch\n\t\t\t\tv-if=\"!modeprops.value || modeprops.value.id === 'create'\"\n\t\t\t\tv-model=\"openAccess\"\n\t\t\t\t:disabled=\"!modeprops.value\">\n\t\t\t\tOpen Access\n\t\t\t</NcCheckboxRadioSwitch>\n\t\t\t<span class=\"button-container\">\n\t\t\t\t<NcButton aria-label=\"close\" @click=\"closeModal\">\n\t\t\t\t\tCancel\n\t\t\t\t</NcButton>\n\t\t\t\t<NcButton\n\t\t\t\t\t:disabled=\"publish.disabled || publish.publishing\"\n\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\taria-label=\"publish\"\n\t\t\t\t\t@click=\"createDeposit\">\n\t\t\t\t\t{{ getPublishLabel() }}\n\t\t\t\t</NcButton>\n\t\t\t</span>\n\t\t\t<NcProgressBar v-if=\"publish.publishTime\" :value=\"progress\" size=\"medium\" />\n\t\t</div>\n\t</NcModal>\n</template>\n\n<script>\nimport axios from '@nextcloud/axios'\nimport { generateUrl } from '@nextcloud/router'\nimport { NcButton, NcCheckboxRadioSwitch, NcModal, NcProgressBar, NcSelect, NcTextField } from '@nextcloud/vue'\nimport PencilIcon from 'vue-material-design-icons/Pencil.vue'\n\nexport default {\n\tname: 'BridgeDialog',\n\tcomponents: {\n\t\tNcModal,\n\t\tNcTextField,\n\t\tNcSelect,\n\t\tNcCheckboxRadioSwitch,\n\t\tNcButton,\n\t\tNcProgressBar,\n\t\tPencilIcon,\n\t},\n\n\tprops: {\n\t\tselectedFiles: {\n\t\t\ttype: Array,\n\t\t\trequired: true,\n\t\t},\n\t},\n\n\tdata() {\n\t\treturn {\n\t\t\tshowDialog: false,\n\t\t\tpublish: {\n\t\t\t\tdisabled: true,\n\t\t\t\tpublishing: false,\n\t\t\t\tpublishTime: null,\n\t\t\t\tpressedOnce: false,\n\t\t\t},\n\n\t\t\ttitle: {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: false,\n\t\t\t\ttext: '',\n\t\t\t\thelpertext: '',\n\t\t\t},\n\n\t\t\tserverprops: {\n\t\t\t\tinputLabel: 'Server',\n\t\t\t\toptions: [],\n\t\t\t\tvalue: null,\n\t\t\t\terror: false,\n\t\t\t},\n\n\t\t\tmodeprops: {\n\t\t\t\tinputLabel: 'Mode',\n\t\t\t\toptions: [\n\t\t\t\t\t{\n\t\t\t\t\t\tid: 'create',\n\t\t\t\t\t\tlabel: 'Create a new draft',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tid: 'attach',\n\t\t\t\t\t\tlabel: 'Attach to existing draft',\n\t\t\t\t\t},\n\t\t\t\t],\n\n\t\t\t\tvalue: null,\n\t\t\t\terror: false,\n\t\t\t},\n\n\t\t\tdepositselectprops: {\n\t\t\t\tinputLabel: 'Select Draft',\n\t\t\t\toptions: [],\n\t\t\t\tdeposits: null,\n\t\t\t\tvalue: null,\n\t\t\t\terror: false,\n\t\t\t},\n\n\t\t\tcommunityprops: {\n\t\t\t\tinputLabel: 'Community',\n\t\t\t\toptions: [],\n\t\t\t\tvalue: null,\n\t\t\t\terror: false,\n\t\t\t},\n\n\t\t\topenAccess: false,\n\t\t\tinfo: {\n\t\t\t\theading: 'Error',\n\t\t\t\tmessage: '',\n\t\t\t\tbuttons: [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'Ok',\n\t\t\t\t\t\ttype: 'error',\n\t\t\t\t\t\tcallback: () => (this.closeModal()),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\n\t\t\t// Technical fields\n\t\t\ttokens: [],\n\t\t\tservers: [],\n\t\t\tprogress: 0, // progress bar\n\t\t}\n\t},\n\n\tasync mounted() {\n\t\tconst serverPromise = this.loadServers()\n\t\tconst communityPromise = this.loadCommunities()\n\t\tconst tokenPromise = this.loadTokens()\n\t\tawait serverPromise\n\t\tawait communityPromise\n\t\tawait tokenPromise\n\n\t\tif (!this.hasValidTokens()) {\n\t\t\tthis.tokens = null\n\t\t\tthis.info.heading = 'You are missing a token!'\n\t\t\tthis.info.message = 'Please set your B2SHARE API token.' // <a class=\"bridgelink\" href=\"/settings/user/b2sharebridge\">here</a>'\n\t\t\t// this.showDialog = true\n\t\t\tthis.info.buttons = [\n\t\t\t\t{\n\t\t\t\t\tlabel: 'Cancel',\n\t\t\t\t\ttype: 'secondary',\n\t\t\t\t\tcallback: () => (this.closeModal()),\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlabel: 'Set API Token',\n\t\t\t\t\ttype: 'primary',\n\t\t\t\t\tcallback: () => (this.redirect('/settings/user/b2sharebridge')),\n\t\t\t\t\thref: generateUrl('/settings/user/b2sharebridge'),\n\t\t\t\t},\n\t\t\t]\n\t\t\treturn\n\t\t}\n\n\t\tif (this.servers.length !== Object.keys(this.tokens).length) {\n\t\t\tthis.info.message = 'Number of servers and tokens differ, please contact an administrator'\n\t\t\tconsole.error(this.info.message)\n\t\t\tthis.tokens = null\n\t\t\t// this.showDialog = true\n\t\t\treturn\n\t\t}\n\n\t\tif (this.servers.length !== 0) {\n\t\t\tthis.servers.forEach((server) => {\n\t\t\t\tconst hasToken = this.tokens[server.id] !== ''\n\t\t\t\tif (hasToken) {\n\t\t\t\t\tconst serverOption = {\n\t\t\t\t\t\tid: server.id,\n\t\t\t\t\t\tlabel: server.name,\n\t\t\t\t\t}\n\t\t\t\t\tthis.serverprops.options.push(serverOption)\n\t\t\t\t\tif (this.serverprops.value === null) {\n\t\t\t\t\t\tconsole.debug('Selected server automatically')\n\t\t\t\t\t\tthis.serverprops.value = serverOption\n\t\t\t\t\t\tthis.onChangeServer() // update communities\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\n\t\t// add progress bar timer running indefinately\n\t\tsetInterval(this.updateProgressBar, 1000)\n\n\t\tthis.showDialog = true\n\t},\n\n\tmethods: {\n\t\t// API stuff\n\t\tasync loadServers() {\n\t\t\tconst urlPath\n\t\t\t\t= '/apps/b2sharebridge/servers?requesttoken='\n\t\t\t\t\t+ encodeURIComponent(OC.requestToken)\n\n\t\t\treturn axios\n\t\t\t\t.get(generateUrl(urlPath))\n\t\t\t\t.then((response) => {\n\t\t\t\t\tconsole.debug('Loaded servers:')\n\t\t\t\t\tconsole.debug(response)\n\t\t\t\t\tthis.servers = response.data\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tthis.info.message = 'Fetching B2SHARE servers failed! Please check your connection or contact an administrator!'\n\t\t\t\t\tconsole.error(this.info.message)\n\t\t\t\t\tconsole.error(error)\n\t\t\t\t})\n\t\t},\n\n\t\tasync loadCommunities() {\n\t\t\tconst urlPath\n\t\t\t\t= '/apps/b2sharebridge/gettabviewcontent?requesttoken='\n\t\t\t\t\t+ encodeURIComponent(OC.requestToken)\n\n\t\t\treturn axios\n\t\t\t\t.get(generateUrl(urlPath))\n\t\t\t\t.then((response) => {\n\t\t\t\t\tconsole.debug('Loaded communities:')\n\t\t\t\t\tconsole.debug(response)\n\t\t\t\t\tthis.communities = response.data\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tthis.info.message = 'Fetching B2SHARE communities failed! Please check your connection or contact an administrator!'\n\t\t\t\t\tconsole.error(this.info.message)\n\t\t\t\t\tconsole.error(error)\n\t\t\t\t})\n\t\t},\n\n\t\tasync loadTokens() {\n\t\t\tconst urlPath\n\t\t\t\t= '/apps/b2sharebridge/apitoken?requesttoken='\n\t\t\t\t\t+ encodeURIComponent(OC.requestToken)\n\n\t\t\treturn axios\n\t\t\t\t.get(generateUrl(urlPath))\n\t\t\t\t.then((response) => {\n\t\t\t\t\tconsole.debug('Successfully requested tokens!')\n\t\t\t\t\tconsole.debug(response.data)\n\t\t\t\t\tif (response.data) {\n\t\t\t\t\t\tthis.tokens = response.data\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.info('No token set!')\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tthis.info.message = 'Fetching tokens failed! Please check your connection or contact an administrator!'\n\t\t\t\t\tconsole.error(this.info.message)\n\t\t\t\t\tconsole.error(error)\n\t\t\t\t})\n\t\t},\n\n\t\tupdateDepositList() {\n\t\t\tif (this.serverprops?.value?.id && this.depositselectprops?.deposits?.[this.serverprops.value.id]?.hits) {\n\t\t\t\tthis.depositselectprops.options = []\n\t\t\t\tconst deposits = this.depositselectprops.deposits[this.serverprops.value.id].hits\n\t\t\t\tdeposits.forEach((deposit) => {\n\t\t\t\t\tconst depositOption = {\n\t\t\t\t\t\tid: deposit.id,\n\t\t\t\t\t\tlabel: deposit.metadata.titles?.[0]?.title ?? deposit.metadata.title,\n\t\t\t\t\t}\n\t\t\t\t\tthis.depositselectprops.options.push(depositOption)\n\t\t\t\t})\n\t\t\t}\n\t\t},\n\n\t\t// Events\n\t\tonChangeServer() {\n\t\t\tconsole.debug('Updating community options')\n\n\t\t\t// reset communityprops\n\t\t\tthis.communityprops.options = []\n\t\t\tthis.communityprops.value = null\n\n\t\t\tif (this.serverprops.value !== null) {\n\t\t\t\t// set communities for new server\n\t\t\t\tthis.communities.forEach((community, _index) => {\n\t\t\t\t\tif (Object.hasOwn(community, 'serverId') && parseInt(community.serverId) === parseInt(this.serverprops.value.id)) {\n\t\t\t\t\t\tconst communityOption = {\n\t\t\t\t\t\t\tid: community.id,\n\t\t\t\t\t\t\tlabel: community.name,\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.communityprops.options.push(communityOption)\n\t\t\t\t\t\tif (community.name === 'EUDAT') { // TODO make this configurable\n\t\t\t\t\t\t\tconsole.debug('Automatically selected EUDAT as community')\n\t\t\t\t\t\t\tthis.communityprops.value = communityOption\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\n\t\t\t\t// update deposit list in attach mode\n\t\t\t\tthis.updateDepositList()\n\t\t\t}\n\t\t\tthis.validate()\n\t\t},\n\n\t\tonChangeMode() {\n\t\t\tconsole.debug('Updating b2share draft list')\n\n\t\t\tif (!this.depositselectprops.deposits) {\n\t\t\t\tthis.fetchAllDrafts()\n\t\t\t}\n\n\t\t\tthis.validate()\n\t\t},\n\n\t\tasync fetchAllDrafts() {\n\t\t\tconst size = 50\n\n\t\t\t/**\n\t\t\t *\n\t\t\t * @param {int} page Page number\n\t\t\t */\n\t\t\tfunction createUrl(page) {\n\t\t\t\tconst urlArr = [\n\t\t\t\t\t'/apps/b2sharebridge/publications?draft=',\n\t\t\t\t\ttrue,\n\t\t\t\t\t'&page=',\n\t\t\t\t\tpage,\n\t\t\t\t\t'&size=',\n\t\t\t\t\tsize,\n\t\t\t\t\t'&requesttoken=',\n\t\t\t\t\tencodeURIComponent(OC.requestToken),\n\t\t\t\t]\n\t\t\t\treturn generateUrl(urlArr.join(''))\n\t\t\t}\n\n\t\t\t// catch the first result and calculate if more are needed\n\t\t\tconst depositData = {}\n\t\t\ttry {\n\t\t\t\tconst firstRes = await axios.get(createUrl(1))\n\t\t\t\tconst servers = Object.keys(firstRes.data)\n\t\t\t\tlet totalNumber = 0\n\t\t\t\tfor (const server of servers) {\n\t\t\t\t\tconst total = firstRes.data[server].total\n\t\t\t\t\tif (total > totalNumber) {\n\t\t\t\t\t\ttotalNumber = total\n\t\t\t\t\t}\n\t\t\t\t\tconst serverData = {\n\t\t\t\t\t\thits: firstRes.data[server].records.hits,\n\t\t\t\t\t\ttotal,\n\t\t\t\t\t}\n\t\t\t\t\tdepositData[server] = serverData\n\t\t\t\t}\n\n\t\t\t\t// catch other results\n\t\t\t\tif (totalNumber > size) {\n\t\t\t\t\t// promises\n\t\t\t\t\tconst requests = []\n\t\t\t\t\tfor (let page = 2; (page - 1) * size < totalNumber; page++) {\n\t\t\t\t\t\trequests.push(axios.get(createUrl(page)))\n\t\t\t\t\t}\n\n\t\t\t\t\tconst responses = await Promise.all(requests)\n\n\t\t\t\t\t// append missing deposits\n\t\t\t\t\tfor (const res of responses) {\n\t\t\t\t\t\tfor (const server of servers) {\n\t\t\t\t\t\t\tdepositData[server].hits.push(...res.data[server].records.hits)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (_error) {\n\t\t\t\tconsole.error('Could not fetch deposits')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\t// save results\n\t\t\tthis.depositselectprops.deposits = depositData\n\n\t\t\t// update deposit list\n\t\t\tthis.updateDepositList()\n\t\t},\n\n\t\thasValidTokens() {\n\t\t\tif (this.tokens === null) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t\tlet validTokenFound = false\n\t\t\tObject.keys(this.tokens).forEach((key) => {\n\t\t\t\tif (this.tokens[key] !== '') {\n\t\t\t\t\tvalidTokenFound = true\n\t\t\t\t}\n\t\t\t})\n\t\t\treturn validTokenFound\n\t\t},\n\n\t\tvalidate(_event) {\n\t\t\tlet isValid = true\n\t\t\tthis.title.error = false\n\t\t\tthis.title.helpertext = ''\n\t\t\tthis.serverprops.error = false\n\t\t\tthis.communityprops.error = false\n\t\t\tthis.modeprops.error = false\n\t\t\tthis.depositselectprops.error = false\n\n\t\t\t// run checks\n\t\t\t// check server\n\t\t\tif (this.serverprops.value === null) {\n\t\t\t\tisValid = false\n\t\t\t\tif (this.publish.pressedOnce) {\n\t\t\t\t\tthis.serverprops.error = true\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// check mode\n\t\t\tif (this.modeprops.value === null) {\n\t\t\t\tisValid = false\n\t\t\t\tif (this.publish.pressedOnce) {\n\t\t\t\t\tthis.modeprops.error = true\n\t\t\t\t}\n\t\t\t} else if (this.modeprops.value.id === 'attach') {\n\t\t\t\t// mode attach: check deposit selected\n\t\t\t\tif (this.depositselectprops.value === null) {\n\t\t\t\t\tisValid = false\n\t\t\t\t\tif (this.publish.pressedOnce) {\n\t\t\t\t\t\tthis.depositselectprops.error = true\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (this.modeprops.value.id === 'create') {\n\t\t\t\t// mode create: check community\n\t\t\t\tif (this.communityprops.value === null) {\n\t\t\t\t\tisValid = false\n\t\t\t\t\tif (this.publish.pressedOnce) {\n\t\t\t\t\t\tthis.communityprops.error = true\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// mode create: check title\n\t\t\t\tif (this.title.text.length <= 3 || this.title.text.length > 128) {\n\t\t\t\t\tisValid = false\n\t\t\t\t\tthis.title.success = false\n\t\t\t\t\tif (this.publish.pressedOnce) {\n\t\t\t\t\t\t// Note both can be false\n\t\t\t\t\t\tthis.title.error = true\n\t\t\t\t\t\tthis.title.helpertext = 'Please set a title with a length between 3 and 128 characters'\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthis.title.error = false\n\t\t\t\t\tthis.title.success = true\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Change publishable with validation\n\t\t\tthis.publish.disabled = !isValid\n\t\t\treturn isValid\n\t\t},\n\n\t\tasync createDeposit() {\n\t\t\t// validate inputs only after first press\n\t\t\tthis.publish.pressedOnce = true\n\t\t\tif (!this.validate()) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tif (!this.selectedFiles.length) {\n\t\t\t\tconsole.error('No files selected')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\t// update progress bar\n\t\t\tthis.publish.publishTime = Date.now()\n\t\t\tthis.publish.publishing = true\n\n\t\t\tlet url = ''\n\t\t\tlet props = {}\n\t\t\tif (this.modeprops.value.id === 'attach') {\n\t\t\t\t/* const draft = this.getCurrentDraft() */\n\t\t\t\turl = '/apps/b2sharebridge/attach'\n\t\t\t\tprops = {\n\t\t\t\t\tids: this.selectedFiles,\n\t\t\t\t\tdraftId: this.depositselectprops.value.id,\n\t\t\t\t\tserver_id: this.serverprops.value.id,\n\t\t\t\t}\n\t\t\t} else if (this.modeprops.value.id === 'create') {\n\t\t\t\turl = '/apps/b2sharebridge/publish'\n\t\t\t\tprops = {\n\t\t\t\t\tids: this.selectedFiles,\n\t\t\t\t\tcommunity: this.communityprops.value.id,\n\t\t\t\t\topen_access: this.openAccess,\n\t\t\t\t\ttitle: this.title.text,\n\t\t\t\t\tserver_id: this.serverprops.value.id,\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treturn\n\t\t\t}\n\t\t\taxios\n\t\t\t\t.post(\n\t\t\t\t\tgenerateUrl(url),\n\t\t\t\t\tprops,\n\t\t\t\t)\n\t\t\t\t.then((response) => {\n\t\t\t\t\tconsole.debug(response)\n\t\t\t\t\tthis.info.heading = 'Transferring to B2SHARE'\n\t\t\t\t\tthis.info.message = response.data.message\n\t\t\t\t\tthis.info.buttons = [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlabel: 'Ok',\n\t\t\t\t\t\t\ttype: 'secondary',\n\t\t\t\t\t\t\tcallback: () => (this.closeModal()),\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlabel: 'Show Deposit',\n\t\t\t\t\t\t\ttype: 'primary',\n\t\t\t\t\t\t\tcallback: () => (this.redirect('/apps/b2sharebridge/?uploads')),\n\t\t\t\t\t\t\thref: generateUrl('/apps/b2sharebridge/?uploads'),\n\t\t\t\t\t\t},\n\t\t\t\t\t]\n\t\t\t\t\tthis.publish.publishing = false\n\t\t\t\t\tthis.publish.publishTime = null\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tif (error.response) {\n\t\t\t\t\t\tif (error.response.status === 413) { // entity too large\n\t\t\t\t\t\t\tthis.info.message = 'Publishing failed! One or more of your files are too large!'\n\t\t\t\t\t\t} else if (error.response.status === 429) { // too many uploads\n\t\t\t\t\t\t\tthis.info.message = 'Publishing failed! You have too many pending uploads, please try again later!'\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.info.message = 'Publishing failed! Please check your connection or contact an administrator!'\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconsole.error(this.info.message)\n\t\t\t\t\t}\n\t\t\t\t\tconsole.error(error)\n\t\t\t\t\tthis.publish.publishing = false\n\t\t\t\t\tthis.publish.publishTime = null\n\t\t\t\t})\n\t\t},\n\n\t\tcloseModal() {\n\t\t\tthis.showDialog = false\n\t\t\tthis.info.message = ''\n\t\t},\n\n\t\tupdateProgressBar() {\n\t\t\tif (!this.publish.publishTime) {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tconst seconds = (Date.now() - this.publish.publishTime) / 1000.0\n\t\t\tconsole.debug(seconds)\n\t\t\tthis.progress = Math.max(Math.min(Math.round(seconds * 20), 99), 10)\n\t\t},\n\n\t\tgetPublishLabel() {\n\t\t\tif (!this.modeprops.value || this.modeprops.value.id === 'create') {\n\t\t\t\treturn 'Publish'\n\t\t\t} else if (this.modeprops.value.id === 'attach') {\n\t\t\t\treturn 'Attach'\n\t\t\t} else {\n\t\t\t\tconsole.error('Unknown mode, please tell an administrator')\n\t\t\t\treturn 'Unknown'\n\t\t\t}\n\t\t},\n\n\t\tredirect(url) {\n\t\t\tthis.$router.push(generateUrl(url))\n\t\t},\n\n\t\t/* getCurrentDraft() {\n\t\t\tif (this.serverprops.value && this.depositselectprops.value) {\n\t\t\t\treturn this.depositselectprops.deposits[this.serverprops.value.id].hits.find((deposit) => deposit.id === this.depositselectprops.value.id)\n\t\t\t}\n\t\t\treturn null\n\t\t}, */\n\t},\n}\n<\/script>\n\n<style>\n#bridgedial {\n\tmin-width: 60%;\n}\n\n#bridgedial .select {\n\twidth: 100%;\n}\n\n#bridgedial .modal__content,\n#infodial .modal__content {\n\tmargin: 50px;\n}\n\n#bridgedial .modal__content h2,\n#infodial .modal__content h2 {\n\ttext-align: center;\n}\n\n#bridgedial .form-group,\n#infodial .form-group {\n\tmargin: calc(var(--default-grid-baseline) * 4) 0;\n\tdisplay: flex;\n\tflex-direction: column;\n\talign-items: flex-start;\n}\n\n#bridgedial .button-container,\n#infodial .button-container {\n\tdisplay: flex;\n\tflex-direction: row;\n\talign-items: start;\n\tjustify-content: flex-end;\n}\n\n#bridgedial .selecterror div {\n\tborder-color: red;\n}\n\n#infodial a {\n\tborder-radius: var(--border-radius-pill);\n}\n</style>\n"],sourceRoot:""}]);const a=i},224(t,e,n){var s=n(171),o=n(3814),r=n(212),i=n(641),a=n(33);const l={class:"modal__content"},d={class:"button-container"},p={class:"modal__content"},c={class:"button-container"};var u=n(6802),h=n(3598),m=n(9095);const b={name:"BridgeDialog",components:{NcModal:h.FH,NcTextField:h.v,NcSelect:h.EQ,NcCheckboxRadioSwitch:h.AO,NcButton:h.x1,NcProgressBar:h.kS,PencilIcon:m.A},props:{selectedFiles:{type:Array,required:!0}},data(){return{showDialog:!1,publish:{disabled:!0,publishing:!1,publishTime:null,pressedOnce:!1},title:{success:!1,error:!1,text:"",helpertext:""},serverprops:{inputLabel:"Server",options:[],value:null,error:!1},modeprops:{inputLabel:"Mode",options:[{id:"create",label:"Create a new draft"},{id:"attach",label:"Attach to existing draft"}],value:null,error:!1},depositselectprops:{inputLabel:"Select Draft",options:[],deposits:null,value:null,error:!1},communityprops:{inputLabel:"Community",options:[],value:null,error:!1},openAccess:!1,info:{heading:"Error",message:"",buttons:[{label:"Ok",type:"error",callback:()=>this.closeModal()}]},tokens:[],servers:[],progress:0}},async mounted(){const t=this.loadServers(),e=this.loadCommunities(),n=this.loadTokens();return await t,await e,await n,this.hasValidTokens()?this.servers.length!==Object.keys(this.tokens).length?(this.info.message="Number of servers and tokens differ, please contact an administrator",console.error(this.info.message),void(this.tokens=null)):(0!==this.servers.length&&this.servers.forEach(t=>{if(""!==this.tokens[t.id]){const e={id:t.id,label:t.name};this.serverprops.options.push(e),null===this.serverprops.value&&(console.debug("Selected server automatically"),this.serverprops.value=e,this.onChangeServer())}}),setInterval(this.updateProgressBar,1e3),void(this.showDialog=!0)):(this.tokens=null,this.info.heading="You are missing a token!",this.info.message="Please set your B2SHARE API token.",void(this.info.buttons=[{label:"Cancel",type:"secondary",callback:()=>this.closeModal()},{label:"Set API Token",type:"primary",callback:()=>this.redirect("/settings/user/b2sharebridge"),href:(0,o.Jv)("/settings/user/b2sharebridge")}]))},methods:{async loadServers(){const t="/apps/b2sharebridge/servers?requesttoken="+encodeURIComponent(OC.requestToken);return u.Ay.get((0,o.Jv)(t)).then(t=>{console.debug("Loaded servers:"),console.debug(t),this.servers=t.data}).catch(t=>{this.info.message="Fetching B2SHARE servers failed! Please check your connection or contact an administrator!",console.error(this.info.message),console.error(t)})},async loadCommunities(){const t="/apps/b2sharebridge/gettabviewcontent?requesttoken="+encodeURIComponent(OC.requestToken);return u.Ay.get((0,o.Jv)(t)).then(t=>{console.debug("Loaded communities:"),console.debug(t),this.communities=t.data}).catch(t=>{this.info.message="Fetching B2SHARE communities failed! Please check your connection or contact an administrator!",console.error(this.info.message),console.error(t)})},async loadTokens(){const t="/apps/b2sharebridge/apitoken?requesttoken="+encodeURIComponent(OC.requestToken);return u.Ay.get((0,o.Jv)(t)).then(t=>{console.debug("Successfully requested tokens!"),console.debug(t.data),t.data?this.tokens=t.data:console.info("No token set!")}).catch(t=>{this.info.message="Fetching tokens failed! Please check your connection or contact an administrator!",console.error(this.info.message),console.error(t)})},updateDepositList(){if(this.serverprops?.value?.id&&this.depositselectprops?.deposits?.[this.serverprops.value.id]?.hits){this.depositselectprops.options=[];this.depositselectprops.deposits[this.serverprops.value.id].hits.forEach(t=>{const e={id:t.id,label:t.metadata.titles?.[0]?.title??t.metadata.title};this.depositselectprops.options.push(e)})}},onChangeServer(){console.debug("Updating community options"),this.communityprops.options=[],this.communityprops.value=null,null!==this.serverprops.value&&(this.communities.forEach((t,e)=>{if(Object.hasOwn(t,"serverId")&&parseInt(t.serverId)===parseInt(this.serverprops.value.id)){const e={id:t.id,label:t.name};this.communityprops.options.push(e),"EUDAT"===t.name&&(console.debug("Automatically selected EUDAT as community"),this.communityprops.value=e)}}),this.updateDepositList()),this.validate()},onChangeMode(){console.debug("Updating b2share draft list"),this.depositselectprops.deposits||this.fetchAllDrafts(),this.validate()},async fetchAllDrafts(){function t(t){const e=["/apps/b2sharebridge/publications?draft=",!0,"&page=",t,"&size=",50,"&requesttoken=",encodeURIComponent(OC.requestToken)];return(0,o.Jv)(e.join(""))}const e={};try{const n=await u.Ay.get(t(1)),s=Object.keys(n.data);let o=0;for(const t of s){const s=n.data[t].total;s>o&&(o=s);const r={hits:n.data[t].records.hits,total:s};e[t]=r}if(o>50){const n=[];for(let e=2;50*(e-1)<o;e++)n.push(u.Ay.get(t(e)));const r=await Promise.all(n);for(const t of r)for(const n of s)e[n].hits.push(...t.data[n].records.hits)}}catch(t){return void console.error("Could not fetch deposits")}this.depositselectprops.deposits=e,this.updateDepositList()},hasValidTokens(){if(null===this.tokens)return!1;let t=!1;return Object.keys(this.tokens).forEach(e=>{""!==this.tokens[e]&&(t=!0)}),t},validate(t){let e=!0;return this.title.error=!1,this.title.helpertext="",this.serverprops.error=!1,this.communityprops.error=!1,this.modeprops.error=!1,this.depositselectprops.error=!1,null===this.serverprops.value&&(e=!1,this.publish.pressedOnce&&(this.serverprops.error=!0)),null===this.modeprops.value?(e=!1,this.publish.pressedOnce&&(this.modeprops.error=!0)):"attach"===this.modeprops.value.id?null===this.depositselectprops.value&&(e=!1,this.publish.pressedOnce&&(this.depositselectprops.error=!0)):"create"===this.modeprops.value.id&&(null===this.communityprops.value&&(e=!1,this.publish.pressedOnce&&(this.communityprops.error=!0)),this.title.text.length<=3||this.title.text.length>128?(e=!1,this.title.success=!1,this.publish.pressedOnce&&(this.title.error=!0,this.title.helpertext="Please set a title with a length between 3 and 128 characters")):(this.title.error=!1,this.title.success=!0)),this.publish.disabled=!e,e},async createDeposit(){if(this.publish.pressedOnce=!0,!this.validate())return;if(!this.selectedFiles.length)return void console.error("No files selected");this.publish.publishTime=Date.now(),this.publish.publishing=!0;let t="",e={};if("attach"===this.modeprops.value.id)t="/apps/b2sharebridge/attach",e={ids:this.selectedFiles,draftId:this.depositselectprops.value.id,server_id:this.serverprops.value.id};else{if("create"!==this.modeprops.value.id)return;t="/apps/b2sharebridge/publish",e={ids:this.selectedFiles,community:this.communityprops.value.id,open_access:this.openAccess,title:this.title.text,server_id:this.serverprops.value.id}}u.Ay.post((0,o.Jv)(t),e).then(t=>{console.debug(t),this.info.heading="Transferring to B2SHARE",this.info.message=t.data.message,this.info.buttons=[{label:"Ok",type:"secondary",callback:()=>this.closeModal()},{label:"Show Deposit",type:"primary",callback:()=>this.redirect("/apps/b2sharebridge/?uploads"),href:(0,o.Jv)("/apps/b2sharebridge/?uploads")}],this.publish.publishing=!1,this.publish.publishTime=null}).catch(t=>{t.response&&(413===t.response.status?this.info.message="Publishing failed! One or more of your files are too large!":429===t.response.status?this.info.message="Publishing failed! You have too many pending uploads, please try again later!":this.info.message="Publishing failed! Please check your connection or contact an administrator!",console.error(this.info.message)),console.error(t),this.publish.publishing=!1,this.publish.publishTime=null})},closeModal(){this.showDialog=!1,this.info.message=""},updateProgressBar(){if(!this.publish.publishTime)return;const t=(Date.now()-this.publish.publishTime)/1e3;console.debug(t),this.progress=Math.max(Math.min(Math.round(20*t),99),10)},getPublishLabel(){return this.modeprops.value&&"create"!==this.modeprops.value.id?"attach"===this.modeprops.value.id?"Attach":(console.error("Unknown mode, please tell an administrator"),"Unknown"):"Publish"},redirect(t){this.$router.push((0,o.Jv)(t))}}};var v=n(5072),f=n.n(v),g=n(7825),y=n.n(g),k=n(7659),A=n.n(k),C=n(5056),x=n.n(C),w=n(540),P=n.n(w),O=n(1113),T=n.n(O),B=n(556),N={};N.styleTagTransform=T(),N.setAttributes=x(),N.insert=A().bind(null,"head"),N.domAPI=y(),N.insertStyleElement=P();f()(B.A,N);B.A&&B.A.locals&&B.A.locals;const S=(0,n(6262).A)(b,[["render",function(t,e,n,s,o,r){const u=(0,i.g2)("NcButton"),h=(0,i.g2)("NcModal"),m=(0,i.g2)("NcSelect"),b=(0,i.g2)("PencilIcon"),v=(0,i.g2)("NcTextField"),f=(0,i.g2)("NcCheckboxRadioSwitch"),g=(0,i.g2)("NcProgressBar");return""!==o.info.message?((0,i.uX)(),(0,i.Wv)(h,{key:0,id:"infodial",name:""},{default:(0,i.k6)(()=>[(0,i.Lk)("div",l,[(0,i.Lk)("h2",null,(0,a.v_)(o.info.heading),1),(0,i.Lk)("p",null,(0,a.v_)(o.info.message),1),(0,i.Lk)("span",d,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(o.info.buttons,t=>((0,i.uX)(),(0,i.Wv)(u,{key:t.label,href:t.href,type:t.type,"area-label":t.label,onClick:t.callback},{default:(0,i.k6)(()=>[(0,i.eW)((0,a.v_)(t.label),1)]),_:2},1032,["href","type","area-label","onClick"]))),128))])])]),_:1})):o.showDialog?((0,i.uX)(),(0,i.Wv)(h,{key:1,id:"bridgedial",name:""},{default:(0,i.k6)(()=>[(0,i.Lk)("div",p,[e[9]||(e[9]=(0,i.Lk)("h2",null,"Upload data to B2SHARE",-1)),(0,i.bF)(m,(0,i.v6)(o.modeprops,{modelValue:o.modeprops.value,"onUpdate:modelValue":[e[0]||(e[0]=t=>o.modeprops.value=t),e[1]||(e[1]=t=>r.onChangeMode())],required:"",class:{selecterror:o.modeprops.error}}),null,16,["modelValue","class"]),o.modeprops.value&&"create"!==o.modeprops.value.id?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.Wv)(v,{key:0,modelValue:o.title.text,"onUpdate:modelValue":[e[2]||(e[2]=t=>o.title.text=t),r.validate],label:"Title",placeholder:"Please enter a title",disabled:!o.modeprops.value,error:o.title.error,success:o.title.success,minlength:"3",maxlength:"128","helper-text":o.title.helpertext},{default:(0,i.k6)(()=>[(0,i.bF)(b,{size:20})]),_:1},8,["modelValue","disabled","error","success","helper-text","onUpdate:modelValue"])),(0,i.bF)(m,(0,i.v6)(o.serverprops,{modelValue:o.serverprops.value,"onUpdate:modelValue":[e[3]||(e[3]=t=>o.serverprops.value=t),r.onChangeServer],required:"",class:{selecterror:o.serverprops.error}}),null,16,["modelValue","class","onUpdate:modelValue"]),o.modeprops.value&&"attach"===o.modeprops.value.id?((0,i.uX)(),(0,i.Wv)(m,(0,i.v6)({key:1},o.depositselectprops,{modelValue:o.depositselectprops.value,"onUpdate:modelValue":[e[4]||(e[4]=t=>o.depositselectprops.value=t),r.validate],required:"",class:{selecterror:o.depositselectprops.error}}),null,16,["modelValue","class","onUpdate:modelValue"])):(0,i.Q3)("",!0),o.modeprops.value&&"create"!==o.modeprops.value.id?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.Wv)(m,(0,i.v6)({key:2},o.communityprops,{modelValue:o.communityprops.value,"onUpdate:modelValue":[e[5]||(e[5]=t=>o.communityprops.value=t),r.validate],disabled:!o.modeprops.value,required:"",class:{selecterror:o.communityprops.error}}),null,16,["modelValue","disabled","class","onUpdate:modelValue"])),o.modeprops.value&&"create"!==o.modeprops.value.id?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.Wv)(f,{key:3,modelValue:o.openAccess,"onUpdate:modelValue":e[6]||(e[6]=t=>o.openAccess=t),disabled:!o.modeprops.value},{default:(0,i.k6)(()=>[...e[7]||(e[7]=[(0,i.eW)(" Open Access ",-1)])]),_:1},8,["modelValue","disabled"])),(0,i.Lk)("span",c,[(0,i.bF)(u,{"aria-label":"close",onClick:r.closeModal},{default:(0,i.k6)(()=>[...e[8]||(e[8]=[(0,i.eW)(" Cancel ",-1)])]),_:1},8,["onClick"]),(0,i.bF)(u,{disabled:o.publish.disabled||o.publish.publishing,variant:"primary","aria-label":"publish",onClick:r.createDeposit},{default:(0,i.k6)(()=>[(0,i.eW)((0,a.v_)(r.getPublishLabel()),1)]),_:1},8,["disabled","onClick"])]),o.publish.publishTime?((0,i.uX)(),(0,i.Wv)(g,{key:4,value:o.progress,size:"medium"},null,8,["value"])):(0,i.Q3)("",!0)])]),_:1})):(0,i.Q3)("",!0)}]]);async function D(t){const e=t.map(t=>t.fileid);return console.debug(e),(0,r.S)(S,{selectedFiles:e}),!0}const _=new s.hY({id:"b2sharebridge-action",title:t=>"B2SharebridgeFileActionTitle",displayName:()=>"B2SHARE",iconSvgInline:()=>'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5 20Q4.22 20 2.61 18.43 1 16.85 1 14.58 1 12.63 2.17 11.1 3.35 9.57 5.25 9.15 5.88 6.85 7.75 5.43 9.63 4 12 4 14.93 4 16.96 6.04 19 8.07 19 11 20.73 11.2 21.86 12.5 23 13.78 23 15.5 23 17.38 21.69 18.69 20.38 20 18.5 20H13Q12.18 20 11.59 19.41 11 18.83 11 18V12.85L9.4 14.4L8 13L12 9L16 13L14.6 14.4L13 12.85V18H18.5Q19.55 18 20.27 17.27 21 16.55 21 15.5 21 14.45 20.27 13.73 19.55 13 18.5 13H17V11Q17 8.93 15.54 7.46 14.08 6 12 6 9.93 6 8.46 7.46 7 8.93 7 11H6.5Q5.05 11 4.03 12.03 3 13.05 3 14.5 3 15.95 4.03 17 5.05 18 6.5 18H9V20M12 13Z" /></svg>',enabled:t=>!!t.length&&(!t.some(t=>t.type===s.pt.Folder)&&t.every(t=>t.permissions!==s.aX.NONE)),exec:async(t,e,n)=>(await D([t]),null),execBatch:async(t,e,n)=>(await D(t),Promise.all(t.map(t=>null))),inline:()=>!1,order:-51});n(3334);n.nc=btoa(OC.requestToken),n.p=(0,o.fg)("b2sharebridge","","js/"),n.p=OC.filePath("b2sharebridge","js","../build/");const U=document.querySelector("[nonce]");n.nc=U.nonce||U.getAttribute("nonce"),(0,s.Gg)(_)}},n={};function s(t){var o=n[t];if(void 0!==o)return o.exports;var r=n[t]={id:t,exports:{}};return e[t].call(r.exports,r,r.exports,s),r.exports}s.m=e,t=[],s.O=(e,n,o,r)=>{if(!n){var i=1/0;for(p=0;p<t.length;p++){for(var[n,o,r]=t[p],a=!0,l=0;l<n.length;l++)(!1&r||i>=r)&&Object.keys(s.O).every(t=>s.O[t](n[l]))?n.splice(l--,1):(a=!1,r<i&&(i=r));if(a){t.splice(p--,1);var d=o();void 0!==d&&(e=d)}}return e}r=r||0;for(var p=t.length;p>0&&t[p-1][2]>r;p--)t[p]=t[p-1];t[p]=[n,o,r]},s.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var n in e)s.o(e,n)&&!s.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},s.e=()=>Promise.resolve(),s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.j="filetabmain",s.p="/apps/b2sharebridge/js/",(()=>{var t={filetabmain:0};s.O.j=e=>0===t[e];var e=(e,n)=>{var o,r,[i,a,l]=n,d=0;if(i.some(e=>0!==t[e])){for(o in a)s.o(a,o)&&(s.m[o]=a[o]);if(l)var p=l(s)}for(e&&e(n);d<i.length;d++)r=i[d],s.o(t,r)&&t[r]&&t[r][0](),t[r]=0;return s.O(p)},n=self.webpackChunkb2sharebridge=self.webpackChunkb2sharebridge||[];n.forEach(e.bind(null,0)),n.push=e.bind(null,n.push.bind(n))})(),s.nc=void 0;var o=s.O(void 0,["vendors"],()=>s(224));o=s.O(o)})();
//# sourceMappingURL=b2sharebridge-filetabmain.js.map?v=2d504e93c4cc0812050b